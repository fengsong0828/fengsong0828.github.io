<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯é¢˜è¯¦æƒ… | LowAltitude Insight</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* è¯¦æƒ…é¡µç‰¹æœ‰æ ·å¼ */
        .topic-detail-card { background: #fff; padding: 30px; border-radius: 8px; margin-bottom: 30px; border:1px solid #e2e8f0; }
        .comment-item { border-bottom: 1px solid #f1f5f9; padding: 20px 0; }
        .comment-item:last-child { border-bottom: none; }
        .action-bar { display: flex; gap: 15px; margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 20px; }
        .btn-like { background: #fef3c7; color: #d97706; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: bold; }
        .btn-like:hover { background: #fde68a; }
    </style>
</head>
<body>

    <header>
        <div class="standard-container">
            <div class="nav-inner">
                <a href="index.html" class="logo">LowAltitude Insight</a>
                <nav class="nav-links">
                    <a href="forum.html">â† è¿”å›è®ºå›åˆ—è¡¨</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="standard-container" style="margin-top: 40px;">
        <!-- è¯é¢˜å†…å®¹åŒº -->
        <div class="topic-detail-card" id="main-topic-area">
            <p>åŠ è½½è¯é¢˜ä¸­...</p>
        </div>

        <!-- è¯„è®ºåˆ—è¡¨åŒº -->
        <div class="topic-detail-card">
            <h3>è¯„è®ºäº¤æµ</h3>
            <div id="comments-container">
                <!-- è¯„è®ºå°†åœ¨è¿™é‡ŒåŠ è½½ -->
            </div>

            <!-- å‘è¡¨è¯„è®ºæ¡† -->
            <div style="margin-top: 30px; background: #f8fafc; padding: 20px; border-radius: 8px;">
                <h4 style="margin-bottom: 15px;">å‘è¡¨çœ‹æ³•</h4>
                <textarea id="comment-input" class="form-control" rows="4" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; margin-bottom:10px;" placeholder="ç†æ€§å‘è¨€ï¼Œæ„å»ºé«˜è´¨é‡ç¤¾åŒº..."></textarea>
                <div style="text-align: right;">
                    <button class="btn btn-primary" onclick="submitComment()">æäº¤è¯„è®º</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://cpvisbzlzatfdqakqsul.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwdmlzYnpsemF0ZmRxYWtxc3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTgwMTYsImV4cCI6MjA3OTk3NDAxNn0.R__eoUjpzFP9_SUxIVnM9T1zpl1pcBTGMzxXLf-Orcg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let topicId = null;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // è·å– URL ä¸­çš„ id å‚æ•°
            const params = new URLSearchParams(window.location.search);
            topicId = params.get('id');
            
            if (!topicId) {
                alert('è¯é¢˜ä¸å­˜åœ¨');
                window.location.href = 'forum.html';
                return;
            }

            await checkUser();
            await loadTopicDetail();
            await loadComments();
        });

        async function checkUser() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) currentUser = session.user;
        }

        // 1. åŠ è½½è¯é¢˜è¯¦æƒ…
        async function loadTopicDetail() {
            const { data, error } = await _supabase
                .from('forum_topics')
                .select('*')
                .eq('id', topicId)
                .single();

            if (error) {
                document.getElementById('main-topic-area').innerHTML = '<p>è¯é¢˜åŠ è½½å¤±è´¥</p>';
                return;
            }

            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = `${data.title} | è®ºå›`;

            // æ¸²æŸ“å†…å®¹
            document.getElementById('main-topic-area').innerHTML = `
                <div style="margin-bottom:10px;">
                    <span class="tag-badge">${data.category}</span>
                    <span style="color:#94a3b8; font-size:0.9rem; margin-left:10px;">${new Date(data.created_at).toLocaleString()}</span>
                </div>
                <h1 style="font-size:1.8rem; margin-bottom:20px;">${data.title}</h1>
                <div style="font-size:1.1rem; line-height:1.8; color:#334155; white-space: pre-wrap;">${data.content}</div>
                
                ${data.source_news_link ? `<div style="margin-top:20px; padding:10px; background:#f1f5f9; font-size:0.9rem;">ğŸ”— å¼•ç”¨æ¥æº: <a href="${data.source_news_link}" target="_blank">${data.source_news_link}</a></div>` : ''}

                <div class="action-bar">
                    <button class="btn-like" onclick="handleLike(${data.likes})">
                        ğŸ‘ ç‚¹èµ (<span id="like-count">${data.likes}</span>)
                    </button>
                    <span style="display:flex; align-items:center; color:#64748b;">ğŸ”¥ çƒ­åº¦: ${data.heat_score}</span>
                </div>
            `;
            
            // å¢åŠ é˜…è¯»æ•° (ç®€å•å®ç°ï¼Œæ¯æ¬¡åˆ·æ–°+1)
            _supabase.rpc('increment_views', { topic_id: topicId }); 
            // æ³¨ï¼šéœ€è¦åœ¨Supabaseåˆ›å»º increment_views å‡½æ•°ï¼Œè¿™é‡Œä¸ºäº†ç®€åŒ–å…ˆå¿½ç•¥æŠ¥é”™
        }

        // 2. åŠ è½½è¯„è®º
        async function loadComments() {
            const { data } = await _supabase
                .from('forum_comments')
                .select('*')
                .eq('topic_id', topicId)
                .order('created_at', { ascending: true });

            const container = document.getElementById('comments-container');
            if (data && data.length > 0) {
                container.innerHTML = '';
                data.forEach(comment => {
                    container.innerHTML += `
                        <div class="comment-item">
                            <div style="font-weight:bold; color:#334155; margin-bottom:5px;">
                                ${comment.user_email ? comment.user_email.split('@')[0] : 'åŒ¿åç”¨æˆ·'}
                                <span style="font-weight:normal; color:#94a3b8; font-size:0.8rem; margin-left:10px;">
                                    ${new Date(comment.created_at).toLocaleString()}
                                </span>
                            </div>
                            <div style="color:#475569;">${comment.content}</div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = '<p style="color:#999;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘ï¼</p>';
            }
        }

        // 3. æäº¤è¯„è®º
        async function submitComment() {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = 'login.html';
                return;
            }
            const content = document.getElementById('comment-input').value;
            if (!content) return;

            // æ’å…¥è¯„è®º
            const { error } = await _supabase.from('forum_comments').insert({
                topic_id: topicId,
                user_id: currentUser.id,
                user_email: currentUser.email,
                content: content
            });

            if (!error) {
                // æ›´æ–°è¯é¢˜è¡¨ä¸­çš„è¯„è®ºæ•°å’Œçƒ­åº¦ (ç®€å•å¤„ç†ï¼šå‰ç«¯è§¦å‘æ›´æ–°æˆ–åç«¯Trigger)
                // è¿™é‡Œæ‰‹åŠ¨æ›´æ–°æœ¬åœ°æ˜¾ç¤ºï¼Œå®é™…åº”é€šè¿‡SQL Triggeråœ¨åç«¯è‡ªåŠ¨åŠ 
                alert('è¯„è®ºæˆåŠŸ');
                document.getElementById('comment-input').value = '';
                loadComments();
                // ç®€å•å¢åŠ çƒ­åº¦é€»è¾‘ (éœ€è¦åœ¨åç«¯å®ç°æ¯”è¾ƒä¸¥è°¨ï¼Œè¿™é‡Œä»…æ¼”ç¤º)
                await _supabase.rpc('increment_stats', { t_id: topicId });
            } else {
                alert(error.message);
            }
        }

        // 4. ç‚¹èµé€»è¾‘
        async function handleLike(currentLikes) {
            if (!currentUser) {
                alert('ç™»å½•åæ‰èƒ½ç‚¹èµ');
                return;
            }
            // ç®€å•å®ç°ï¼šç›´æ¥+1 (ç”Ÿäº§ç¯å¢ƒåº”æ£€æŸ¥ forum_likes è¡¨é˜²æ­¢é‡å¤)
            const newLikes = currentLikes + 1;
            
            const { error } = await _supabase
                .from('forum_topics')
                .update({ likes: newLikes, heat_score: newLikes * 2 }) // å‡è®¾çƒ­åº¦ä¸»è¦å—ç‚¹èµå½±å“
                .eq('id', topicId);

            if (!error) {
                document.getElementById('like-count').innerText = newLikes;
                // ç¦ç”¨æŒ‰é’®
                document.querySelector('.btn-like').disabled = true;
                document.querySelector('.btn-like').style.background = '#e2e8f0';
            }
        }
    </script>
</body>
</html>