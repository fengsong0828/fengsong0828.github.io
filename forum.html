<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®ºå›äº¤æµ | LowAltitude Insight</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* è®ºå›ä¸“å±æ ·å¼è¡¥å…… */
        .forum-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .topic-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 15px; transition: all 0.2s; }
        .topic-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: #cbd5e1; }
        .topic-meta { font-size: 0.85rem; color: #64748b; display: flex; gap: 15px; margin-top: 10px; align-items: center; }
        .topic-heat { color: #f59e0b; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: white; width: 90%; max-width: 600px; padding: 25px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .tag-badge { background: #e0f2fe; color: #0284c7; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <!-- å¼•ç”¨åŸHeaderï¼Œä½†åœ¨navä¸­å°†è®ºå›è®¾ä¸ºactive -->
    <header>
        <div class="standard-container">
            <div class="nav-inner">
                <a href="index.html" class="logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    LowAltitude<span>Insight</span>
                </a>
                <button class="mobile-menu-btn" onclick="toggleMenu()">â˜°</button>
                <nav class="nav-links" id="navMenu">
                    <a href="index.html">é¦–é¡µ</a>
                    <a href="news.html">èµ„è®¯å¿«æŠ¥</a>
                    <a href="policies.html">æ”¿ç­–æ³•è§„</a>
                    <a href="tech.html">æŠ€æœ¯å‰æ²¿</a>
                    <a href="companies.html">å…¬å¸æ•°æ®åº“</a>
                    <a href="forum.html" class="active">è®ºå›äº¤æµ</a>
                </nav>
                <div class="header-actions">
                    <button class="btn btn-outline">æœç´¢</button>
                    <button class="btn btn-primary" id="auth-btn">è®¢é˜…/ç™»å½•</button>
                </div>
            </div>
        </div>
    </header>

    <!-- è®ºå›ä¸»ä½“ -->
    <div class="standard-container" style="margin-top: 40px; margin-bottom: 60px;">
        <div class="main-layout-grid">
            
            <!-- å·¦ä¾§ï¼šè¯é¢˜åˆ—è¡¨ -->
            <main class="content-left">
                <div class="forum-header">
                    <div class="section-title">æœ€æ–°è¯é¢˜</div>
                    <button class="btn btn-primary" onclick="openPostModal()">+ å‘å¸ƒæ–°è¯é¢˜</button>
                </div>
                
                <!-- ç­›é€‰æ ‡ç­¾ -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="loadTopics('new')">æœ€æ–°å‘å¸ƒ</button>
                    <button class="btn btn-outline" onclick="loadTopics('hot')">ğŸ”¥ çƒ­é—¨æ’è¡Œ</button>
                </div>

                <div id="topic-list-container">
                    <p style="text-align:center; padding: 20px; color:#999;">æ­£åœ¨åŠ è½½è®¨è®º...</p>
                </div>
            </main>

            <!-- å³ä¾§ï¼šä¾§è¾¹æ  -->
            <aside class="sidebar">
                <!-- çƒ­é—¨æ ‡ç­¾/åˆ†ç±» -->
                <div class="sidebar-widget">
                    <div class="widget-title">çƒ­é—¨æ¿å—</div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        <span class="tag-badge"># eVTOLé€‚èˆª</span>
                        <span class="tag-badge"># ç‰©æµæ— äººæœº</span>
                        <span class="tag-badge"># æ”¿ç­–è§£è¯»</span>
                        <span class="tag-badge"># æŠ•èµ„é£å‘</span>
                    </div>
                </div>

                <!-- ç¤¾åŒºå…¬çº¦ -->
                <div class="sidebar-widget">
                    <div class="widget-title">ç¤¾åŒºå…¬çº¦</div>
                    <p style="font-size:0.85rem; color:#64748b;">
                        è¯·ç†æ€§è®¨è®ºï¼Œæ–‡æ˜å‘è¨€ã€‚ç¦æ­¢å‘å¸ƒå¹¿å‘ŠåŠè¿è§„å†…å®¹ã€‚é«˜è´¨é‡çš„æŠ€æœ¯è®¨è®ºå°†è¢«ç½®é¡¶æ¨èã€‚
                    </p>
                </div>
            </aside>
        </div>
    </div>

    <!-- å‘å¸–å¼¹çª— Modal -->
    <div class="modal-overlay" id="postModal">
        <div class="modal-box">
            <h3 style="margin-bottom: 20px;">å‘å¸ƒæ–°è¯é¢˜</h3>
            <div class="form-group">
                <label>æ ‡é¢˜</label>
                <input type="text" id="post-title" class="form-control" placeholder="è¯·è¾“å…¥æ ‡é¢˜...">
            </div>
            <div class="form-group">
                <label>åˆ†ç±»</label>
                <select id="post-category" class="form-control">
                    <option value="ç»¼åˆè®¨è®º">ç»¼åˆè®¨è®º</option>
                    <option value="æ”¿ç­–è§£è¯»">æ”¿ç­–è§£è¯»</option>
                    <option value="æŠ€æœ¯æ¢è®¨">æŠ€æœ¯æ¢è®¨</option>
                    <option value="å¸‚åœºåˆ†æ">å¸‚åœºåˆ†æ</option>
                </select>
            </div>
            <div class="form-group">
                <label>å†…å®¹</label>
                <textarea id="post-content" class="form-control" rows="5" placeholder="åˆ†äº«ä½ çš„è§‚ç‚¹..."></textarea>
            </div>
            <!-- éšè—åŸŸï¼šå¼•ç”¨æ¥æº -->
            <input type="hidden" id="post-source">
            
            <div style="display:flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-outline" onclick="closePostModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="submitTopic()">å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- Footer (ä¿æŒä¸€è‡´ï¼Œçœç•¥éƒ¨åˆ†ä»£ç ) -->
    <footer>
        <div class="standard-container">
            <div style="text-align:center; color:#64748b; font-size:0.85rem; padding: 20px;">
                &copy; 2025 LowAltitude Insight.
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://cpvisbzlzatfdqakqsul.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwdmlzYnpsemF0ZmRxYWtxc3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTgwMTYsImV4cCI6MjA3OTk3NDAxNn0.R__eoUjpzFP9_SUxIVnM9T1zpl1pcBTGMzxXLf-Orcg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await checkUser();
            loadTopics('new');
            checkUrlParamsForShare(); // æ£€æŸ¥æ˜¯å¦æ˜¯ä»æ–°é—»é¡µè·³è½¬è¿‡æ¥çš„
        });

        // 1. æ£€æŸ¥ç”¨æˆ·ç™»å½•
        async function checkUser() {
            const { data: { session } } = await _supabase.auth.getSession();
            const btn = document.getElementById('auth-btn');
            if (session) {
                currentUser = session.user;
                btn.innerText = currentUser.email.split('@')[0];
                btn.style.backgroundColor = '#475569';
            } else {
                btn.innerText = 'ç™»å½•';
                btn.onclick = () => window.location.href = 'login.html';
            }
        }

        // 2. åŠ è½½è¯é¢˜åˆ—è¡¨
        async function loadTopics(sortType) {
            const container = document.getElementById('topic-list-container');
            container.innerHTML = '<p style="text-align:center; padding:20px;">åŠ è½½ä¸­...</p>';

            let query = _supabase.from('forum_topics').select('*');

            if (sortType === 'hot') {
                query = query.order('heat_score', { ascending: false });
            } else {
                query = query.order('created_at', { ascending: false });
            }

            const { data, error } = await query;

            if (error) {
                console.error(error);
                return;
            }

            if (data && data.length > 0) {
                container.innerHTML = '';
                data.forEach(topic => {
                    const date = new Date(topic.created_at).toLocaleDateString();
                    // çƒ­åº¦è®¡ç®—é€»è¾‘å±•ç¤º
                    const isHot = topic.heat_score > 50 ? 'ğŸ”¥ ' : '';
                    
                    container.innerHTML += `
                        <div class="topic-card">
                            <div style="display:flex; justify-content:space-between;">
                                <span class="tag-badge">${topic.category}</span>
                                <span style="font-size:0.8rem; color:#94a3b8;">${date}</span>
                            </div>
                            <!-- ç‚¹å‡»æ ‡é¢˜è·³è½¬åˆ°è¯¦æƒ…é¡µ -->
                            <h3 style="margin: 10px 0;">
                                <a href="forum-topic.html?id=${topic.id}" style="text-decoration:none; color:#1e293b;">
                                    ${isHot}${topic.title}
                                </a>
                            </h3>
                            <p style="color:#64748b; font-size:0.9rem; margin-bottom:15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${topic.content}
                            </p>
                            <div class="topic-meta">
                                <span>ğŸ‘¤ ${topic.user_email ? topic.user_email.split('@')[0] : 'ç”¨æˆ·'}</span>
                                <span>ğŸ’¬ ${topic.comments_count} è¯„è®º</span>
                                <span class="topic-heat">âš¡ ${topic.heat_score} çƒ­åº¦</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = '<p style="text-align:center;">æš‚æ— è¯é¢˜ï¼Œæ¥å‘å¸ƒç¬¬ä¸€ä¸ªå§ï¼</p>';
            }
        }

        // 3. æ¨¡æ€æ¡†é€»è¾‘
        function openPostModal() {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•åå‘å¸ƒè¯é¢˜');
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('postModal').style.display = 'flex';
        }
        function closePostModal() {
            document.getElementById('postModal').style.display = 'none';
        }

        // 4. å¤„ç†ä»æ–°é—»é¡µé¢è½¬å‘è¿‡æ¥çš„é€»è¾‘
        // å‡è®¾æ–°é—»é¡µé“¾æ¥ä¸º: forum.html?action=share&title=æ–°é—»æ ‡é¢˜&source=æ–°é—»é“¾æ¥
        function checkUrlParamsForShare() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'share') {
                const title = urlParams.get('title');
                const source = urlParams.get('source');
                
                if (title) {
                    document.getElementById('post-title').value = `[è®¨è®º] ${title}`;
                    document.getElementById('post-content').value = `æˆ‘å¯¹è¿™ç¯‡æ–°é—»å¾ˆæ„Ÿå…´è¶£ï¼Œå¤§å®¶æ€ä¹ˆçœ‹ï¼Ÿ\nåŸæ–‡é“¾æ¥: ${source}`;
                    document.getElementById('post-source').value = source;
                    // è‡ªåŠ¨æ‰“å¼€å¼¹çª— (éœ€è¦ç¨å¾®å»¶è¿Ÿç­‰å¾… Auth æ£€æŸ¥ï¼Œæˆ–è€…ç®€å•å¤„ç†)
                    setTimeout(() => {
                         if(currentUser) openPostModal();
                    }, 1000);
                }
            }
        }

        // 5. æäº¤æ–°è¯é¢˜
        async function submitTopic() {
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const category = document.getElementById('post-category').value;
            const source = document.getElementById('post-source').value;

            if (!title || !content) {
                alert('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }

            const { error } = await _supabase.from('forum_topics').insert({
                user_id: currentUser.id,
                user_email: currentUser.email,
                title: title,
                content: content,
                category: category,
                source_news_link: source,
                heat_score: 1 // åˆå§‹çƒ­åº¦
            });

            if (error) {
                alert('å‘å¸ƒå¤±è´¥: ' + error.message);
            } else {
                alert('å‘å¸ƒæˆåŠŸï¼');
                closePostModal();
                loadTopics('new'); // åˆ·æ–°åˆ—è¡¨
                // æ¸…ç©ºè¡¨å•
                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
            }
        }
        
        function toggleMenu() { document.getElementById('navMenu').classList.toggle('active'); }
    </script>
</body>
</html>