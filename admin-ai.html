<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½é‡‡ç¼–åŠ©æ‰‹ | LowAltitude Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { 
            background: #f1f5f9; 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* å“åº”å¼ç½‘æ ¼å¸ƒå±€ */
        .ai-container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 30px; 
            padding: 40px 20px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }

        .panel { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        }

        .panel h2 { 
            margin-bottom: 20px; 
            color: #0f172a; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 15px; 
            font-size: 1.2rem; 
            font-weight: 600;
        }

        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #475569; 
            font-size: 0.9rem; 
        }

        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 20px; 
            border: 1px solid #cbd5e1; 
            border-radius: 8px; 
            font-family: inherit; 
            font-size: 0.95rem; 
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 2px #bfdbfe; 
        }

        /* æ–‡æœ¬åŸŸé«˜åº¦ */
        #rawText { height: 200px; }
        #outContent { height: 100px; min-height: 200px; resize: vertical; line-height: 1.6; font-family: 'SFMono-Regular', Consolas, monospace; }

        /* æŒ‰é’®æ ·å¼ */
        .btn-ai { 
            background: linear-gradient(135deg, #6366f1, #3b82f6); 
            color: white; 
            border: none; 
            width: 100%; 
            padding: 16px; 
            font-size: 1rem; 
            font-weight: bold; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: 0.3s; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 8px;
        }
        .btn-ai:hover:not(:disabled) { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); 
        }
        .btn-ai:disabled { 
            background: #94a3b8; 
            cursor: not-allowed; 
            transform: none; 
        }

        .loading-spinner {
            width: 20px; height: 20px; 
            border: 3px solid #ffffff; 
            border-bottom-color: transparent; 
            border-radius: 50%; 
            display: none; 
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* æ ‡ç­¾é¢„è§ˆ */
        .tag-preview { 
            display: inline-block; 
            background: #eff6ff; 
            color: #3b82f6; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 0.8rem; 
            margin-right: 5px; 
            margin-top: 5px; 
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .ai-container {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            .btn-ai span { font-size: 0.95rem; }
        }
    </style>
</head>
<body>

    <header style="background:#fff; padding:15px 0; border-bottom:1px solid #e2e8f0;">
        <div class="standard-container" style="display:flex; justify-content:space-between; align-items:center; max-width:1400px; margin:0 auto; padding:0 20px;">
            <div class="logo" style="font-weight:800; font-size:1.2rem; color:#0f172a;">LowAltitude <span style="color:#3b82f6;">Admin</span></div>
            <a href="index.html" style="font-size:0.9rem; color:#64748b; text-decoration:none;">â† è¿”å›é¦–é¡µ</a>
        </div>
    </header>

    <div class="standard-container ai-container">
        
        <!-- å·¦ä¾§ï¼šç´ æè¾“å…¥ -->
        <div class="panel">
            <h2>1. ç´ æä¸é…ç½®</h2>
            
            <label>ç´ ææ¥æº</label>
            <select id="inputType">
                <option value="url">ç²˜è´´ç½‘é¡µé“¾æ¥ (URL)</option>
                <option value="text">ç²˜è´´çº¯æ–‡æœ¬</option>
            </select>

            <div id="urlInputGroup">
                <label>æ–‡ç« é“¾æ¥ (URL)</label>
                <input type="url" id="rawUrl" placeholder="https://mp.weixin.qq.com/s/..." />
                <p style="font-size:0.8rem; color:#94a3b8; margin-top:-10px; margin-bottom:20px;">
                    * AI å°†è‡ªåŠ¨æŠ“å–ç½‘é¡µå†…å®¹è¿›è¡Œé‡å†™
                </p>
            </div>

            <div id="textInputGroup" style="display:none;">
                <label>åŸå§‹æ–‡æœ¬</label>
                <textarea id="rawText" placeholder="è¯·åœ¨æ­¤ç²˜è´´ä¼šè®®çºªè¦ã€æ”¿ç­–åŸæ–‡æˆ–æ–°é—»é€šç¨¿..."></textarea>
            </div>

            <label>å‘å¸ƒæ ç›®</label>
            <select id="targetCategory">
                <option value="èµ„è®¯å¿«æŠ¥">èµ„è®¯å¿«æŠ¥ (News)</option>
                <option value="æ”¿ç­–æ³•è§„">æ”¿ç­–æ³•è§„ (Policy)</option>
                <option value="æŠ€æœ¯å‰æ²¿">æŠ€æœ¯å‰æ²¿ (Tech)</option>
                <option value="æ·±åº¦æŠ¥å‘Š">æ·±åº¦æŠ¥å‘Š (Deep Report)</option>
            </select>

            <button class="btn-ai" id="generateBtn" onclick="generateNews()">
                <span class="loading-spinner" id="spinner"></span>
                <span class="btn-text" id="btnText">âœ¨ AI ä¸€é”®ç”Ÿæˆæ–°é—»ç¨¿</span>
            </button>
        </div>

        <!-- å³ä¾§ï¼šç»“æœç¼–è¾‘ -->
        <div class="panel">
            <h2>2. ç”Ÿæˆç»“æœ (å¯ç¼–è¾‘)</h2>
            
            <label>æ ‡é¢˜</label>
            <input type="text" id="outTitle" placeholder="ç­‰å¾… AI ç”Ÿæˆ...">
            
            <label>æ‘˜è¦</label>
            <textarea id="outSummary" style="height: 80px;" placeholder="ç­‰å¾… AI ç”Ÿæˆ..."></textarea>
            
            <label>æ­£æ–‡ (HTML æ ¼å¼)</label>
            <textarea id="outContent" placeholder="ç­‰å¾… AI ç”Ÿæˆ..."></textarea>
            
            <div style="display:flex; gap:15px; flex-wrap: wrap;">
                <div style="flex:1; min-width: 200px;">
                    <label>æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
                    <input type="text" id="outTags" placeholder="eVTOL, èèµ„" oninput="updateTagPreview()">
                </div>
                <div style="width:160px;">
                    <label>å‘å¸ƒæ—¥æœŸ</label>
                    <input type="date" id="outDate">
                </div>
            </div>

            <!-- æ ‡ç­¾é¢„è§ˆ -->
            <div id="tagPreviewContainer" style="margin-top: 8px;"></div>

            <button class="btn btn-primary" style="width:100%; padding:15px; font-size:1rem;" onclick="saveToDatabase()">
                ğŸ’¾ ä¿å­˜
            </button>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const supabaseUrl = 'https://cpvisbzlzatfdqakqsul.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwdmlzYnpsemF0ZmRxYWtxc3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTgwMTYsImV4cCI6MjA3OTk3NDAxNn0.R__eoUjpzFP9_SUxIVnM9T1zpl1pcBTGMzxXLf-Orcg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // â˜…â˜…â˜… å…¨å±€å˜é‡ï¼šç”¨äºæš‚å­˜ AI è¿”å›çš„å®Œæ•´æ•°æ®ï¼ˆåŒ…å«UIä¸Šæ²¡æ˜¾ç¤ºçš„å­—æ®µï¼‰ â˜…â˜…â˜…
        let currentAiData = null; 
        // ==============================================

        // ====== å…¨å±€å‡½æ•°ï¼šè®¾ç½®æŒ‰é’® loading çŠ¶æ€ ======
        function setLoading(btn, isLoading) {
            const spinner = btn.querySelector('.loading-spinner');
            const text = btn.querySelector('.btn-text');
            btn.disabled = isLoading;
            spinner.style.display = isLoading ? 'inline-block' : 'none';
            if (text) text.innerText = isLoading ? 'ğŸ§  AI æ­£åœ¨é˜…è¯»å¹¶æ’°å†™...' : 'âœ¨ AI ä¸€é”®ç”Ÿæˆæ–°é—»ç¨¿';
        }

        // ====== åˆ‡æ¢è¾“å…¥æ¨¡å¼ ======
        function toggleInput() {
            const type = document.getElementById('inputType').value;
            document.getElementById('textInputGroup').style.display = type === 'text' ? 'block' : 'none';
            document.getElementById('urlInputGroup').style.display = type === 'url' ? 'block' : 'none';
        }

        // ====== åŠ¨æ€æ›´æ–°æ ‡ç­¾é¢„è§ˆ ======
        function updateTagPreview() {
            const container = document.getElementById('tagPreviewContainer');
            container.innerHTML = '';
            const val = document.getElementById('outTags').value || '';
            const tags = val.split(/,|ï¼Œ/).map(t => t.trim()).filter(t => t);

            tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = 'tag-preview';
                span.textContent = tag;
                container.appendChild(span);
            });
        }

        // ====== é¡µé¢åŠ è½½åˆå§‹åŒ– + æƒé™æ£€æŸ¥ ======
        document.addEventListener('DOMContentLoaded', async () => {
            // --- æƒé™éªŒè¯ ---
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                alert('è¯·å…ˆç™»å½•');
                location.href = 'login.html';
                return;
            }

            const { data: profile, error } = await _supabase
                .from('profiles')
                .select('is_admin')
                .eq('id', session.user.id)
                .single();

            if (error || !profile?.is_admin) {
                alert('æƒé™ä¸è¶³');
                location.href = 'index.html';
                return;
            }

            // --- åˆå§‹åŒ–é»˜è®¤å€¼ ---
            if (!document.getElementById('outDate').value) {
                document.getElementById('outDate').value = new Date().toISOString().split('T')[0];
            }

            // --- ç»‘å®šäº‹ä»¶ ---
            document.getElementById('inputType').addEventListener('change', toggleInput);
            document.getElementById('outTags').addEventListener('input', updateTagPreview);
            
            // æ–‡æœ¬åŸŸè‡ªé€‚åº”é«˜åº¦
            const contentArea = document.getElementById('outContent');
            contentArea.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight + 10) + 'px';
            });

            // é»˜è®¤éšè—æ–‡æœ¬è¾“å…¥åŒº
            toggleInput();
        });

        // ====== 1. è°ƒç”¨ AI ç”Ÿæˆæ–°é—» ======
        async function generateNews() {
            const inputType = document.getElementById('inputType').value;
            // è·å–ä¸‹æ‹‰æ¡†é€‰ä¸­çš„æ–‡æœ¬å€¼ï¼Œä¾‹å¦‚ "æ”¿ç­–æ³•è§„"
            const categorySelect = document.getElementById('targetCategory');
            // æ³¨æ„ï¼šè¿™é‡Œä¼ ç»™ AI çš„ category åº”è¯¥æ˜¯ä¸­æ–‡åç§°ï¼Œä¸ Edge Function é‡Œçš„ switch case åŒ¹é…
            const categoryLabel = categorySelect.options[categorySelect.selectedIndex].text.split(' ')[0]; // å– "èµ„è®¯å¿«æŠ¥"

            let content = inputType === 'text' 
                ? document.getElementById('rawText').value.trim()
                : document.getElementById('rawUrl').value.trim();

            if (!content) {
                alert('è¯·è¾“å…¥å†…å®¹æˆ–é“¾æ¥');
                return;
            }

            const btn = document.getElementById('generateBtn');
            setLoading(btn, true);

            try {
                // è°ƒç”¨ Edge Function
                const { data, error } = await _supabase.functions.invoke('generate-news', {
                    body: { inputType, content, category: categoryLabel }
                });

                if (error) throw error;

                // â˜…â˜…â˜… å…³é”®æ­¥éª¤ï¼šå°† AI è¿”å›çš„å®Œæ•´æ•°æ®å­˜å…¥å…¨å±€å˜é‡ â˜…â˜…â˜…
                currentAiData = data; 
                console.log("AIè¿”å›çš„å®Œæ•´æ•°æ®:", currentAiData);

                // å¡«å…… UI ä¸Šçš„é€šç”¨å­—æ®µ (Title, Summary, Content, Tags, Date)
                document.getElementById('outTitle').value = data?.title || '';
                document.getElementById('outSummary').value = data?.summary || '';
                
                // å¤„ç†æ­£æ–‡ï¼šæœ‰äº›åˆ†ç±» AI å¯èƒ½è¿”å›åœ¨ contentï¼Œæœ‰äº›åœ¨ summary
                // æˆ‘ä»¬ä¼˜å…ˆå– contentï¼Œæ²¡æœ‰åˆ™å– summary
                const mainBody = data?.content || data?.summary || '';
                document.getElementById('outContent').value = mainBody;
                
                // å¤„ç†æ ‡ç­¾
                document.getElementById('outTags').value = Array.isArray(data?.tags) ? data.tags.join(', ') : '';
                
                // å¤„ç†æ—¥æœŸ
                if (data?.publish_date) {
                    document.getElementById('outDate').value = data.publish_date;
                }

                // æ›´æ–°æ ‡ç­¾é¢„è§ˆ
                updateTagPreview();
                // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                document.getElementById('outContent').style.height = 'auto';
                document.getElementById('outContent').style.height = (document.getElementById('outContent').scrollHeight + 10) + 'px';

            } catch (err) {
                console.error('[AI ç”Ÿæˆé”™è¯¯]', err);
                alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚\nè¯¦ç»†ä¿¡æ¯è§æ§åˆ¶å°ï¼š' + err.message);
            } finally {
                setLoading(btn, false);
            }
        }

        // ====== 2. ä¿å­˜åˆ°æ•°æ®åº“ (æ ¹æ® AI å­—æ®µæ™ºèƒ½ç­›é€‰) ======
        async function saveToDatabase() {
            // 1. è·å– UI ä¸Šç”¨æˆ·å¯èƒ½ä¿®æ”¹è¿‡çš„å€¼
            const uiTitle = document.getElementById('outTitle').value.trim();
            const uiSummary = document.getElementById('outSummary').value.trim();
            const uiContent = document.getElementById('outContent').value.trim();
            const uiDate = document.getElementById('outDate').value;
            const uiTagsStr = document.getElementById('outTags').value;
            
            // å°†æ ‡ç­¾å­—ç¬¦ä¸²è½¬æ•°ç»„
            const uiTags = uiTagsStr.split(/,|ï¼Œ/).map(t => t.trim()).filter(t => t);

            if (!uiTitle || !uiContent) {
                alert('æ ‡é¢˜å’Œæ­£æ–‡ä¸èƒ½ä¸ºç©º');
                return;
            }

            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                location.href = 'login.html';
                return;
            }

            // 2. ç¡®å®šç›®æ ‡è¡¨æ ¼å’Œåˆ†ç±»
            // value å¯¹åº”çš„æ˜¯ HTML option çš„ value: "èµ„è®¯å¿«æŠ¥", "æ”¿ç­–æ³•è§„", "æŠ€æœ¯å‰æ²¿"
            const selectedCategoryValue = document.getElementById('targetCategory').value;

            // æ ç›® -> è¡¨å æ˜ å°„
            const categoryTableMap = {
                'èµ„è®¯å¿«æŠ¥': 'news',
                'æ”¿ç­–æ³•è§„': 'policies',
                'æŠ€æœ¯å‰æ²¿': 'tech_trends',
                'æ·±åº¦æŠ¥å‘Š': 'deep_reports'
            };

            const tableName = categoryTableMap[selectedCategoryValue];
            if (!tableName) {
                alert('ä¸æ”¯æŒçš„æ ç›®ç±»å‹');
                return;
            }

            // 3. æ„å»ºåŸºç¡€è®°å½• (æ‰€æœ‰è¡¨éƒ½æœ‰çš„å­—æ®µ)
            let record = {
                title: uiTitle,
                summary: uiSummary, // æ”¿ç­–è¡¨å’Œæ–°é—»è¡¨éƒ½æœ‰ summary
                publish_date: uiDate,
                draft: true, // é»˜è®¤ä¸ºè‰ç¨¿
                // å¦‚æœæ˜¯ URL æ¨¡å¼ï¼Œä¿å­˜æ¥æºé“¾æ¥
                source_url: document.getElementById('inputType').value === 'url' ? document.getElementById('rawUrl').value.trim() : null
            };

            // å¦‚æœæœ‰ currentAiDataï¼Œå°è¯•ä»ä¸­æå–å›¾ç‰‡
            if (currentAiData && currentAiData.image_url) {
                record.image_url = currentAiData.image_url;
            }

            // â˜…â˜…â˜… 4. æ ¹æ®ä¸åŒè¡¨æ ¼ï¼Œä» currentAiData æå–ç‰¹å®šå­—æ®µ â˜…â˜…â˜…
            // å¦‚æœ currentAiData ä¸ºç©º (ç”¨æˆ·æ²¡ç‚¹ç”Ÿæˆç›´æ¥æ‰‹å†™)ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
            const ai = currentAiData || {}; 

            if (tableName === 'news') {
                // --- èµ„è®¯å¿«æŠ¥ (News) ---
                record.content = uiContent; // åªæœ‰ news è¡¨éœ€è¦ content å­—æ®µ (å‡è®¾æ”¿ç­–ç”¨ summary å­˜å…¨æ–‡)
                // ä¼˜å…ˆä½¿ç”¨ UI æ•°æ®ï¼Œå¦‚æœ AI æä¾›äº† news_category åˆ™ä½¿ç”¨ï¼Œå¦åˆ™é»˜è®¤
                record.category = ai.news_category || 'å¸‚åœºåŠ¨æ€'; 
                record.source = ai.source || 'ç½‘ç»œæœé›†';
                // News è¡¨ä¸ä¸€å®šæœ‰ tags å­—æ®µï¼Œçœ‹ä½ æ•°æ®åº“å®šä¹‰ã€‚å¦‚æœæœ‰ï¼ŒåŠ ä¸Šï¼š
                // record.tags = uiTags; 
            } 
            else if (tableName === 'policies') {
                // --- æ”¿ç­–æ³•è§„ (Policies) ---
                // æ³¨æ„ï¼šæ”¿ç­–è¡¨é€šå¸¸ç”¨ summary å­˜é•¿æ–‡ï¼Œæˆ– file_urlã€‚
                // å¦‚æœä½ çš„ policies è¡¨æœ‰ content å­—æ®µï¼Œåˆ™è§£å¼€ä¸‹é¢æ³¨é‡Šï¼š
                // record.content = uiContent; 
                
                // å¦‚æœ policies è¡¨æŠŠæ­£æ–‡å­˜åœ¨ summary é‡Œ (å› ä¸º summary æ˜¯ textarea full)
                record.summary = uiContent; 

                record.department = ai.department || 'ç›¸å…³éƒ¨é—¨';
                record.level = ai.policy_level || 'å›½å®¶éƒ¨å§”'; // level æ˜¯å…³é”®å­—ï¼Œæ•°æ®åº“å­—æ®µåä¸º level
                record.region_type = ai.region_type || 'å›½å†…';
                // Policy è¡¨é€šå¸¸æ²¡æœ‰ tags
            } 
            else if (tableName === 'tech_trends') {
                // --- æŠ€æœ¯å‰æ²¿ (Tech Trends) ---
                // Tech è¡¨åŒæ ·ï¼Œçœ‹æ­£æ–‡æ˜¯å­˜ summary è¿˜æ˜¯ content
                record.summary = uiContent; 

                record.type = ai.tech_type || 'æ–°äº§å“';
                record.org = ai.org || 'æœªçŸ¥æœºæ„';
            }
            else if (tableName === 'deep_reports') {
                // --- æ·±åº¦æŠ¥å‘Š (Deep Reports) ---
                record.content = uiContent; // æ·±åº¦æŠ¥å‘Šå¿…é¡»æœ‰é•¿æ–‡å†…å®¹
                record.author = ai.author || 'ç‰¹é‚€ä¸“å®¶'; // ä» AI ç»“æœä¸­æå–ä½œè€…ï¼Œæˆ–è€…é»˜è®¤
                // title, summary, publish_date, draft, image_url å·²ç»åœ¨ä¸Šé¢åŸºç¡€è®°å½•é‡Œå¤„ç†äº†
            }

            // 5. æ‰§è¡Œæ’å…¥
            try {
                console.log(`æ­£åœ¨å‘ [${tableName}] æ’å…¥æ•°æ®:`, record);
                const { error } = await _supabase.from(tableName).insert([record]);

                if (error) throw error;

                alert('âœ… ä¿å­˜æˆåŠŸï¼\næ–‡ç« å·²å­˜å…¥â€œå¾…å‘å¸ƒâ€åˆ—è¡¨ã€‚');
                // å¯é€‰æ‹©è·³è½¬æˆ–é‡ç½®
                location.href = 'admin.html';

            } catch (err) {
                console.error('[ä¿å­˜å¤±è´¥]', err);
                alert('ä¿å­˜å¤±è´¥: ' + err.message);
            }
        }
    </script>
</body>
</html>
