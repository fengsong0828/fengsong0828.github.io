<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç«™åå°ç®¡ç† | LowAltitude Insight</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* åå°å¸ƒå±€æ ·å¼ */
        .admin-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .admin-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Tab åˆ‡æ¢æ  */
        .table-tabs { display: flex; gap: 10px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 20px; }
        .tab-btn { 
            padding: 8px 20px; border: none; background: none; font-size: 1rem; 
            font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px; 
        }
        .tab-btn:hover { background: #f1f5f9; }
        .tab-btn.active { background: #e0f2fe; color: #0284c7; }

        /* è¡¨æ ¼æ ·å¼ */
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: var(--card-shadow); table-layout: fixed; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f1f5f9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .data-table th { background: #f8fafc; font-weight: 600; color: #64748b; font-size: 0.9rem; }
        .data-table tr:hover { background: #f8fafc; }
        
        /* æŒ‰é’® */
        .action-btn { padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; border: none; margin-right: 5px; color: white;}
        .btn-edit { background: #3b82f6; }
        .btn-delete { background: #ef4444; }

        /* åŠ¨æ€è¡¨å•æ ·å¼ */
        .form-row { margin-bottom: 15px; }
        .form-row label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: #334155; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-family: inherit; }
        .form-row textarea { height: 80px; resize: vertical; }
        .modal-box { max-width: 600px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

    <header>
        <div class="standard-container">
            <div class="nav-inner">
                <a href="index.html" class="logo">LowAltitude<span>Admin</span></a>
                <div style="display:flex; gap:15px; align-items:center;">
                    <span id="admin-name" style="font-size:0.9rem; font-weight:bold;">Loading...</span>
                    <a href="admin-ai.html" class="btn btn-secondary" style="font-size:0.9rem; padding:6px 12px; background:#10b981; color:white; border-radius:4px; text-decoration:none;">
                        ğŸ¤– AIæ–°é—»ç”Ÿæˆ
                    </a>
                    <a href="index.html" style="font-size:0.9rem; color:#64748b;">é€€å‡ºåå°</a>
                </div>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <!-- 1. é¡¶éƒ¨åˆ‡æ¢æ  -->
        <div class="admin-top-bar">
            <div class="table-tabs">
                <button class="tab-btn active" onclick="switchTable('news')">èµ„è®¯å¿«æŠ¥</button>
                <button class="tab-btn" onclick="switchTable('policies')">æ”¿ç­–æ³•è§„</button>
                <button class="tab-btn" onclick="switchTable('tech_trends')">æŠ€æœ¯å‰æ²¿</button>
                <button class="tab-btn" onclick="switchTable('deep_reports')">æ·±åº¦æŠ¥å‘Š</button>
                <button class="tab-btn" onclick="switchTable('companies')">å…¬å¸æ•°æ®åº“</button>
            </div>
            <button class="btn btn-primary" onclick="openModal()">+ æ–°å¢æ•°æ®</button>
        </div>

        <!-- 2. é€šç”¨æ•°æ®è¡¨æ ¼ -->
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead id="table-head">
                    <!-- JS è‡ªåŠ¨ç”Ÿæˆè¡¨å¤´ -->
                </thead>
                <tbody id="table-body">
                    <tr><td style="text-align:center;">è¯·é€‰æ‹©æ•°æ®è¡¨...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 3. é€šç”¨ç¼–è¾‘å¼¹çª— -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-box">
            <div class="modal-close" onclick="closeModal()">Ã—</div>
            <div class="modal-title" id="modal-title">ç¼–è¾‘æ•°æ®</div>
            
            <!-- åŠ¨æ€ç”Ÿæˆçš„è¡¨å•å®¹å™¨ -->
            <div id="dynamic-form"></div>

            <div style="margin-top:20px;">
                <button class="btn btn-primary" style="width:100%;" onclick="saveData()">ä¿å­˜æäº¤</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ================= é…ç½® Supabase =================
        const supabaseUrl = 'https://cpvisbzlzatfdqakqsul.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwdmlzYnpsemF0ZmRxYWtxc3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTgwMTYsImV4cCI6MjA3OTk3NDAxNn0.R__eoUjpzFP9_SUxIVnM9T1zpl1pcBTGMzxXLf-Orcg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // ================= æ•°æ®è¡¨é…ç½® =================
        const SCHEMAS = {
            news: {
                label: 'èµ„è®¯å¿«æŠ¥',
                fields: [
                    { key: 'title', label: 'æ ‡é¢˜', type: 'text', listShow: true },
                    { key: 'category', label: 'åˆ†ç±»', type: 'select', options: ['æ”¿ç­–æ³•è§„','èµ„æœ¬åŠ¨æ€','æŠ€æœ¯å‰æ²¿','å¸‚åœºåŠ¨æ€','å›½é™…åŠ¨æ€'], listShow: true },
                    { key: 'publish_date', label: 'æ—¥æœŸ', type: 'date', listShow: true },
                    { key: 'source', label: 'æ¥æº', type: 'text', listShow: true },
                    { key: 'image_url', label: 'å›¾ç‰‡è·¯å¾„', type: 'text' },
                    { key: 'summary', label: 'æ‘˜è¦', type: 'textarea' },
                    { key: 'draft', label: 'è‰ç¨¿çŠ¶æ€', type: 'boolean' } 
                ],
                sort: { col: 'publish_date', order: false }
            },
            policies: {
                label: 'æ”¿ç­–æ³•è§„',
                fields: [
                    { key: 'title', label: 'æ”¿ç­–åç§°', type: 'text', listShow: true },
                    { key: 'department', label: 'å‘å¸ƒéƒ¨é—¨', type: 'text', listShow: true },
                    { key: 'level', label: 'å±‚çº§', type: 'select', options: ['å›½å®¶éƒ¨å§”','åœ°æ–¹æ”¿åºœ','è¡Œä¸šåä¼š','å›½é™…ç»„ç»‡'], listShow: true },
                    { key: 'region_type', label: 'åŒºåŸŸ', type: 'select', options: ['å›½å†…','å›½é™…'], listShow: true },
                    { key: 'publish_date', label: 'å‘å¸ƒæ—¥æœŸ', type: 'date', listShow: true },
                    { key: 'file_url', label: 'æ–‡ä»¶é“¾æ¥', type: 'text' },
                    { key: 'summary', label: 'è§£è¯»æ‘˜è¦', type: 'textarea' },
                    { key: 'draft', label: 'è‰ç¨¿çŠ¶æ€', type: 'boolean' } 
                ],
                sort: { col: 'publish_date', order: false }
            },
            tech_trends: {
                label: 'æŠ€æœ¯å‰æ²¿',
                fields: [
                    { key: 'title', label: 'æ ‡é¢˜', type: 'text', listShow: true },
                    { key: 'type', label: 'ç±»å‹', type: 'select', options: ['å­¦æœ¯è®ºæ–‡','å‘æ˜ä¸“åˆ©','æ–°äº§å“','æŠ€æœ¯ç™½çš®ä¹¦'], listShow: true },
                    { key: 'org', label: 'æœºæ„/ä½œè€…', type: 'text', listShow: true },
                    { key: 'publish_date', label: 'æ—¥æœŸ', type: 'date', listShow: true },
                    { key: 'image_url', label: 'å›¾ç‰‡è·¯å¾„', type: 'text' },
                    { key: 'summary', label: 'æŠ€æœ¯ç®€ä»‹', type: 'textarea' },
                    { key: 'draft', label: 'è‰ç¨¿çŠ¶æ€', type: 'boolean' } 
                ],
                sort: { col: 'publish_date', order: false }
            },
            deep_reports: {
                label: 'æ·±åº¦æŠ¥å‘Š',
                fields: [
                    { key: 'title', label: 'æŠ¥å‘Šæ ‡é¢˜', type: 'text', listShow: true },
                    { key: 'author', label: 'ç‰¹é‚€ä¸“å®¶/ä½œè€…', type: 'text', listShow: true },
                    { key: 'publish_date', label: 'å‘å¸ƒæ—¥æœŸ', type: 'date', listShow: true },
                    { key: 'image_url', label: 'å°é¢å›¾é“¾æ¥', type: 'text' },
                    { key: 'summary', label: 'æ ¸å¿ƒè§‚ç‚¹ (æ‘˜è¦)', type: 'textarea' },
                    // content å­—æ®µè¾ƒé•¿ï¼Œtype ç”¨ textareaï¼Œä½†åœ¨åˆ—è¡¨é¡µä¸æ˜¾ç¤º (listShow: false)
                    { key: 'content', label: 'æŠ¥å‘Šæ­£æ–‡ (æ”¯æŒæ¢è¡Œ)', type: 'textarea' }, 
                    // å¢åŠ è‰ç¨¿çŠ¶æ€æ§åˆ¶
                    // { key: 'draft', label: 'è‰ç¨¿çŠ¶æ€ (Trueä¸ºéšè—)', type: 'boolean', listShow: true }
                ],
                sort: { col: 'publish_date', order: false } // æŒ‰æ—¥æœŸå€’åº
            },
            companies: {
                label: 'å…¬å¸åº“',
                fields: [
                    { key: 'name', label: 'å…¬å¸åç§°', type: 'text', listShow: true },
                    { key: 'logo_text', label: 'Logoç¼©å†™', type: 'text', placeholder: 'å¦‚: EH' },
                    { key: 'location', label: 'æ‰€åœ¨åœ°', type: 'text', listShow: true },
                    { key: 'tags', label: 'æ ‡ç­¾ (é€—å·åˆ†éš”)', type: 'array', placeholder: 'eVTOL,å·²ä¸Šå¸‚', listShow: true },
                    { key: 'is_listed', label: 'æ˜¯å¦ä¸Šå¸‚', type: 'boolean' },
                    { key: 'description', label: 'ç®€ä»‹', type: 'textarea' },
                    { key: 'draft', label: 'è‰ç¨¿çŠ¶æ€', type: 'boolean' } 
                ],
                sort: { col: 'id', order: true }
            },
        };

        // å…¨å±€å˜é‡
        let currentTable = 'news';
        let currentEditId = null;
        let currentDataList = []; // â˜…â˜…â˜… ä¿®å¤Bugå…³é”®ï¼šæŠŠæ•°æ®å­˜åœ¨è¿™é‡Œï¼Œè€Œä¸æ˜¯æ‹¼æ¥åˆ°HTMLé‡Œ

        // ================= 1. åˆå§‹åŒ– =================
        document.addEventListener('DOMContentLoaded', async function() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { location.href = 'login.html'; return; }

            const { data: profile } = await _supabase
                .from('profiles').select('is_admin, username').eq('id', session.user.id).single();

            if (!profile || profile.is_admin !== true) {
                alert('æƒé™ä¸è¶³'); location.href = 'index.html'; return;
            }

            document.getElementById('admin-name').innerText = `ç®¡ç†å‘˜: ${profile.username}`;
            switchTable('news'); 
        });

        // ================= 2. åˆ—è¡¨åŠ è½½ä¸é€»è¾‘ä¿®æ­£ =================
        function switchTable(tableName) {
            currentTable = tableName;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === SCHEMAS[tableName].label);
            });

            // ç”Ÿæˆè¡¨å¤´
            const thead = document.getElementById('table-head');
            const schema = SCHEMAS[tableName];
            let headHtml = '<tr>';
            schema.fields.forEach(f => {
                if (f.listShow) headHtml += `<th>${f.label}</th>`;
            });
            headHtml += `<th width="100">çŠ¶æ€</th><th width="200">æ“ä½œ</th></tr>`; // ç¨å¾®åŠ å®½æ“ä½œåˆ—
            thead.innerHTML = headHtml;

            loadList();
        }

        async function loadList() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">åŠ è½½ä¸­...</td></tr>';

            const schema = SCHEMAS[currentTable];
            const { data, error } = await _supabase
                .from(currentTable)
                .select('*')
                .order(schema.sort.col, { ascending: schema.sort.order });

            if (error) { tbody.innerHTML = '<tr><td colspan="10" style="color:red;">åŠ è½½å¤±è´¥</td></tr>'; return; }

            // â˜…â˜…â˜… ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿åç»­æŸ¥æ‰¾
            currentDataList = data;
            tbody.innerHTML = '';

            data.forEach(item => {
                const tr = document.createElement('tr');
                let rowHtml = '';
                
                // æ¸²æŸ“æ™®é€šåˆ—
                schema.fields.forEach(f => {
                    if (f.listShow) {
                        let val = item[f.key];
                        if (f.type === 'array' && Array.isArray(val)) val = val.join(', ');
                        if (f.type === 'boolean' && f.key !== 'draft') val = val ? 'æ˜¯' : 'å¦';
                        rowHtml += `<td>${val || '-'}</td>`;
                    }
                });

                // â˜…â˜…â˜… æ ¸å¿ƒé€»è¾‘ä¿®æ­£ â˜…â˜…â˜…
                // åªæœ‰ draft === false æ‰æ˜¯â€œå·²å‘å¸ƒâ€ã€‚
                // draft === true æˆ– draft === null (ç©º) éƒ½æ˜¯â€œå¾…å‘å¸ƒâ€ã€‚
                const isPublished = (item.draft === false);

                const statusBadge = isPublished 
                    ? '<span style="color:#16a34a; background:#dcfce7; padding:2px 8px; border-radius:4px; font-size:0.8rem;">å·²å‘å¸ƒ</span>'
                    : '<span style="color:#d97706; background:#fef3c7; padding:2px 8px; border-radius:4px; font-size:0.8rem;">å¾…å‘å¸ƒ</span>';

                // â˜…â˜…â˜… æŒ‰é’®ç”Ÿæˆ (ä¿®å¤äº†å¼•å·Bug) â˜…â˜…â˜…
                // 1. ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
                let actionButtons = `
                    <button class="action-btn btn-edit" onclick="triggerEdit('${item.id}')">ç¼–è¾‘</button>
                    <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">åˆ é™¤</button>
                `;

                // 2. åŠ¨æ€å‘å¸ƒ/éšè—æŒ‰é’®
                if (isPublished) {
                    // å¦‚æœå·²å‘å¸ƒï¼Œæ˜¾ç¤ºã€éšè—ã€‘
                    actionButtons += `<button class="action-btn" style="background:#dc2626;" onclick="hideItem('${item.id}')">éšè—</button>`;
                } else {
                    // å¦‚æœå¾…å‘å¸ƒ (true æˆ– null)ï¼Œæ˜¾ç¤ºã€å‘å¸ƒã€‘
                    actionButtons += `<button class="action-btn" style="background:#059669;" onclick="publishItem('${item.id}')">å‘å¸ƒ</button>`;
                }

                rowHtml += `<td>${statusBadge}</td><td>${actionButtons}</td>`;
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        // ================= 3. æ“ä½œåŠŸèƒ½ (æŒ‰éœ€ä¿®æ”¹) =================
        
        // ã€éšè—ã€‘ï¼šå°† draft è®¾ä¸º null (æ ¹æ®ä½ çš„è¦æ±‚)
        async function hideItem(id) {
            if (!confirm('ç¡®å®šè¦éšè—è¿™æ¡å†…å®¹å—ï¼Ÿ\néšè—åå°†ä¸å†å¯¹å¤–å±•ç¤ºã€‚')) return;
            // å°† draft æ›´æ–°ä¸º null
            const { error } = await _supabase.from(currentTable).update({ draft: null }).eq('id', id);
            if (error) alert('éšè—å¤±è´¥: ' + error.message); else loadList();
        }

        // ã€å‘å¸ƒã€‘ï¼šå°† draft è®¾ä¸º false
        async function publishItem(id) {
            if (!confirm('ç¡®å®šè¦å‘å¸ƒå—ï¼Ÿ\nå°†åœ¨å‰å°å…¬å¼€æ˜¾ç¤ºã€‚')) return;
            // å°† draft æ›´æ–°ä¸º false
            const { error } = await _supabase.from(currentTable).update({ draft: false }).eq('id', id);
            if (error) alert('å‘å¸ƒå¤±è´¥: ' + error.message); else loadList();
        }

        // ç¼–è¾‘åŠŸèƒ½ (ä¿®å¤ä¼ é€’å¯¹è±¡çš„é—®é¢˜)
        function triggerEdit(id) {
            const item = currentDataList.find(i => i.id == id); // ä»å…¨å±€å˜é‡é‡Œæ‰¾
            if (item) openModal(item);
        }

        // åˆ é™¤åŠŸèƒ½
        async function deleteItem(id) {
            if (!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
            const { error } = await _supabase.from(currentTable).delete().eq('id', id);
            if (error) alert('åˆ é™¤å¤±è´¥'); else loadList();
        }

        // ================= 4. å¼¹çª—ä¸ä¿å­˜ =================
        function openModal(item = null) {
            currentEditId = item ? item.id : null;
            document.getElementById('modal-title').innerText = item ? `ç¼–è¾‘ ${SCHEMAS[currentTable].label}` : `æ–°å¢ ${SCHEMAS[currentTable].label}`;
            const formContainer = document.getElementById('dynamic-form');
            let html = '';

            SCHEMAS[currentTable].fields.forEach(f => {
                // å¦‚æœæ˜¯ draft å­—æ®µï¼Œé»˜è®¤æ–°å¢æ—¶æ˜¯â€œå¾…å‘å¸ƒâ€
                let value = item ? (item[f.key] !== undefined ? item[f.key] : '') : '';
                
                if (f.type === 'array' && Array.isArray(value)) value = value.join(',');

                html += `<div class="form-row"><label>${f.label}</label>`;

                if (f.type === 'select') {
                    html += `<select id="field-${f.key}">`;
                    f.options.forEach(opt => {
                        html += `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`;
                    });
                    html += `</select>`;
                } else if (f.type === 'textarea') {
                    html += `<textarea id="field-${f.key}">${value}</textarea>`;
                } else if (f.type === 'date') {
                    html += `<input type="date" id="field-${f.key}" value="${value}">`;
                } else if (f.type === 'boolean') {
                    // å¸ƒå°”å€¼å¤„ç†
                    if (f.key === 'draft') {
                        // é€»è¾‘ï¼štrue/null = å¾…å‘å¸ƒ(æ˜¯è‰ç¨¿), false = å·²å‘å¸ƒ(éè‰ç¨¿)
                        // åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯è‰ç¨¿
                        const isDraft = (value === true || value === null || value === ''); 
                        
                        html += `
                            <select id="field-${f.key}">
                                <option value="true" ${isDraft ? 'selected' : ''}>å¾…å‘å¸ƒ (è‰ç¨¿)</option>
                                <option value="false" ${!isDraft ? 'selected' : ''}>ç›´æ¥å‘å¸ƒ</option>
                            </select>
                        `;
                    } else {
                        const isTrue = (value === true);
                        html += `
                            <select id="field-${f.key}">
                                <option value="true" ${isTrue ? 'selected' : ''}>æ˜¯</option>
                                <option value="false" ${!isTrue ? 'selected' : ''}>å¦</option>
                            </select>
                        `;
                    }
                } else {
                    html += `<input type="text" id="field-${f.key}" value="${value}" placeholder="${f.placeholder || ''}">`;
                }
                html += `</div>`;
            });

            formContainer.innerHTML = html;
            document.getElementById('edit-modal').style.display = 'flex';
        }

        async function saveData() {
            const formData = {};
            SCHEMAS[currentTable].fields.forEach(f => {
                const el = document.getElementById(`field-${f.key}`);
                let val = el.value;

                if (f.type === 'array') val = val ? val.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s) : [];
                
                if (f.type === 'boolean') {
                    // å­—ç¬¦ä¸² 'true'/'false' è½¬ boolean
                    val = (val === 'true');
                    // å¦‚æœæ˜¯ draft ä¸”ä¸º trueï¼ŒæŒ‰ä½ çš„é€»è¾‘ï¼Œå¯ä»¥å­˜ true æˆ–è€… null
                    // è¿™é‡Œæˆ‘ä»¬å­˜ true ä»£è¡¨è‰ç¨¿ï¼Œå‘å¸ƒæ—¶æ”¹ä¸º falseï¼Œéšè—æ—¶æ”¹ä¸º null
                    // ä¸ºäº†ç»Ÿä¸€ï¼Œè¿™é‡Œä¿å­˜æ—¶å¦‚æœé€‰äº†â€œå¾…å‘å¸ƒâ€ï¼Œå°±å­˜ true
                }
                
                formData[f.key] = val;
            });

            const query = currentEditId 
                ? _supabase.from(currentTable).update(formData).eq('id', currentEditId)
                : _supabase.from(currentTable).insert([formData]);

            const { error } = await query;
            if (error) { alert('ä¿å­˜å¤±è´¥: ' + error.message); }
            else { alert('æˆåŠŸï¼'); closeModal(); loadList(); }
        }

        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
    </script>
</body>
</html>