<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LowAltitude Insight | ä½ç©ºç»æµæ´å¯Ÿ</title>
    <!-- å¼•å…¥å¤–éƒ¨æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- 1. å¯¼èˆªæ  Header -->
    <header>
        <div class="standard-container">
            <div class="nav-inner">
                <!-- Logoï¼šç‚¹å‡»å›é¦–é¡µ -->
                <a href="index.html" class="logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    LowAltitude<span>Insight</span>
                </a>
                
                <!-- æ‰‹æœºç«¯èœå•æŒ‰é’® -->
                <button class="mobile-menu-btn" onclick="toggleMenu()">â˜°</button>

                <!-- å¯¼èˆªé“¾æ¥ -->
                <nav class="nav-links" id="navMenu">
                    <a href="index.html" class="active">é¦–é¡µ</a>
                    <a href="news.html">èµ„è®¯å¿«æŠ¥</a>
                    <a href="policies.html">æ”¿ç­–æ³•è§„</a>
                    <a href="tech.html">æŠ€æœ¯å‰æ²¿</a>
                    <a href="companies.html">å…¬å¸æ•°æ®åº“</a>
                    <!-- â˜…â˜…â˜… æ–°å¢ä»£ç ï¼šè®ºå›äº¤æµ â˜…â˜…â˜… -->
                    <a href="forum.html">è®ºå›äº¤æµ</a>
                </nav>

                <!-- åŠŸèƒ½æŒ‰é’® -->
                <div class="header-actions">
                    <button class="btn btn-outline">æœç´¢</button>
                    <!-- ç™»å½•æŒ‰é’® -->
                    <button class="btn btn-primary" id="auth-btn">è®¢é˜…/ç™»å½•</button>
                </div>
            </div>

        </div>
    </header>

    <!-- 2. Hero åŒºåŸŸ -->
    <section class="hero">
        <div class="standard-container">
            <h1>æ„å»ºä½ç©ºç»æµçš„æ•°å­—åŸºç¡€è®¾æ–½</h1>
            <p>å®æ—¶æ´å¯Ÿå…¨çƒ eVTOLã€æ— äººæœºç‰©æµåŠåŸå¸‚ç©ºä¸­äº¤é€šï¼ˆUAMï¼‰çš„æ”¿ç­–ã€æŠ€æœ¯ä¸èµ„æœ¬åŠ¨æ€ã€‚</p>
            <a href="products.html" class="btn btn-primary" style="padding: 12px 32px; display:inline-block;">
                æµè§ˆå…¨çƒä½ç©ºé£è¡Œå™¨äº§å“åº“
            </a>
        </div>
    </section>

    <!-- 3. æ ¸å¿ƒæ•°æ®ä»ªè¡¨ç›˜ (å¸¦åŠ¨ç”») -->
    <div class="standard-container">
        <div class="dashboard-grid">
            <a href="chart-funding.html" class="data-card" style="text-decoration: none; color: inherit;">
                <div class="data-label">å…¨çƒèèµ„æ€»é¢</div>
                <div class="data-value">$4.2B</div>
                <span class="trend-indicator">â–² 12% åŒæ¯”å¢é•¿</span>
            </a>
            <a href="chart-cities.html" class="data-card" style="text-decoration: none; color: inherit;">
                <div class="data-label">è¯•ç‚¹åŸå¸‚</div>
                <div class="data-value">26</div>
                <span class="trend-indicator">â–² æ–°å¢ 3 ä¸ª</span>
            </a>
            <a href="chart-patents.html" class="data-card" style="text-decoration: none; color: inherit;">
                <div class="data-label">æœ¬å‘¨æ–°å¢ä¸“åˆ©</div>
                <div class="data-value">142</div>
                <span class="trend-indicator">ä¸»è¦é¢†åŸŸ: ç”µæ± /é£æ§</span>
            </a>
            <a href="chart-companies.html" class="data-card" style="text-decoration: none; color: inherit;">
                <div class="data-label">å·²æ”¶å½•ä¼ä¸š</div>
                <div class="data-value">850+</div>
                <span class="trend-indicator">æŸ¥çœ‹å…¨æ™¯å›¾è°± â†’</span>
            </a>
        </div>
    </div>

    <!-- 4. ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="standard-container">
        <div class="main-layout-grid">
            <!-- å·¦ä¾§ï¼šæœ€æ–°åŠ¨æ€ -->
            <main class="content-left">
                <div class="section-header">
                    <div class="section-title">æœ€æ–°åŠ¨æ€ (News & Policies & Tech)</div>
                    <!-- éœ€æ±‚ï¼šå…ˆéšè—â€œæŸ¥çœ‹æ›´å¤šâ€ -->
                    <a href="news.html" class="section-link" style="display: none;">æŸ¥çœ‹æ›´å¤š ></a>
                </div>

                <!-- åŠ¨æ€å†…å®¹å®¹å™¨ -->
                <div class="news-feed" id="unified-feed-container">
                    <div class="loading-spinner">æ­£åœ¨èšåˆå¤šæºæ•°æ®...</div>
                </div>

                <!-- æ–°å¢ï¼šåˆ†é¡µæ§åˆ¶æŒ‰é’® -->
                <div class="pagination-controls" id="pagination-box" style="display:none; justify-content:center; gap:20px; margin-top:30px;">
                    <button class="btn btn-outline" onclick="changePage(-1)" id="btn-prev">ä¸Šä¸€é¡µ</button>
                    <span id="page-indicator" style="line-height: 34px; color:#64748b; font-size:0.9rem;">1 / 1</span>
                    <button class="btn btn-outline" onclick="changePage(1)" id="btn-next">ä¸‹ä¸€é¡µ</button>
                </div>
            </main>

            <!-- å³ä¾§ï¼šä¾§è¾¹æ  -->
            <!-- å³ä¾§ï¼šä¾§è¾¹æ  -->
            <aside class="sidebar">
                
                <!-- 1. è®¢é˜…æ¡† (ä¿æŒä¸å˜) -->
                <div class="sidebar-widget newsletter-box">
                    <div style="font-weight:700; color:var(--primary-blue); text-align:center;">è®¢é˜…è¡Œä¸šæ—¥æŠ¥</div>
                    <p style="font-size:0.85rem; color:#64748b; margin-bottom:10px; text-align:center;">æ¯æ—©8ç‚¹ï¼Œè·å–ä½ç©ºç»æµæ ¸å¿ƒæƒ…æŠ¥ã€‚</p>
                    <input type="email" class="newsletter-input" placeholder="è¾“å…¥é‚®ç®±åœ°å€">
                    <button class="btn btn-primary" style="width: 100%;">å…è´¹è®¢é˜…</button>
                </div>

                <!-- 2. æ”¿ç­–æ³•è§„æ›´æ–° (JSä¼šè‡ªåŠ¨å¡«å……å†…å®¹) -->
                <div class="sidebar-widget">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 1px solid #e2e8f0; padding-bottom:10px;">
                        <div class="widget-title" style="margin-bottom:0; border:none; padding:0;">æ·±åº¦æŠ¥å‘Š</div>
                        <a href="reports.html" style="font-size:0.85rem; color:#3b82f6; font-weight:600;">æŸ¥çœ‹æ›´å¤š &gt;</a>
                    </div>
                    <div class="report-list-mini" id="home-report-list">
                        <p style="color:#999; font-size:0.85rem; text-align:center;">åŠ è½½ä¸­...</p>
                    </div>
                </div>

                <!-- 3. ä¸“å®¶è§‚ç‚¹ (é™æ€å±•ç¤º) -->
                <div class="sidebar-widget">
                    <div class="widget-title">ä¸“å®¶è§‚ç‚¹</div>
                    <div class="expert-profile">
                        <div class="expert-avatar"></div> <!-- è¿™é‡Œç¨åå¯ä»¥æ¢æˆ <img src="..."> -->
                        <div class="expert-info">
                            <div class="expert-name">FengSong åšå£«</div>
                            <div class="expert-role">ä½ç©ºç»æµä¸“å®¶</div>
                        </div>
                    </div>
                    <p class="expert-quote">
                        "2025å¹´å°†æ˜¯eVTOLé€‚èˆªå–è¯çš„å…³é”®å¹´ä»½ï¼Œä½†åŸºç¡€è®¾æ–½å»ºè®¾ä»æ˜¯çŸ­æ¿..."
                    </p>
                </div>
            </aside>
        </div>
    </div>

    <!-- 5. å…¬å¸æ•°æ®åº“é¢„è§ˆ -->
    <div class="standard-container">
        <div class="company-section" style="margin-bottom: 60px;">
            <div class="section-header">
                <div class="section-title">è¡Œä¸šå›¾è°± & å…¬å¸åº“</div>
                <a href="companies.html" class="section-link">æµè§ˆå…¨éƒ¨ ></a>
            </div>
            <div class="company-grid" id="home-company-container">
                <p style="text-align:center; color:#999;">æ­£åœ¨åŠ è½½å…¬å¸æ•°æ®...</p>
            </div>
        </div>
    </div>

     <!-- 6. Footer -->
    <footer>
        <div class="standard-container">
            <div class="footer-grid">
                <div class="footer-col brand-col">
                    <h4 style="color:white; margin-bottom:15px; font-size:1.2rem;">LowAltitude Insight</h4>
                    <p style="font-size:0.9rem; color:#94a3b8; line-height: 1.6; margin-bottom: 20px;">
                        è¿æ¥æ”¿ç­–ã€èµ„æœ¬ä¸æŠ€æœ¯ï¼Œæ‰“é€ ä½ç©ºç»æµé¢†åŸŸçš„æ•°å­—åŒ–åŸºç¡€è®¾æ–½ä¸å†³ç­–å¼•æ“ã€‚
                    </p>
                    <div style="display:flex; gap:15px;">
                        <a href="#" style="width:32px; height:32px; background:#334155; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        </a>
                        <a href="#" style="width:32px; height:32px; background:#334155; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
                        </a>
                        <a href="mailto:contact@example.com" style="width:32px; height:32px; background:#334155; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                        </a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4 style="color:white; margin-bottom:20px;">æ ¸å¿ƒæ¿å—</h4>
                    <ul style="font-size:0.9rem; color:#94a3b8;">
                        <li style="margin-bottom:10px;"><a href="news.html" style="color:#94a3b8;">èµ„è®¯å¿«æŠ¥</a></li>
                        <li style="margin-bottom:10px;"><a href="policies.html" style="color:#94a3b8;">æ”¿ç­–æ³•è§„</a></li>
                        <li style="margin-bottom:10px;"><a href="companies.html" style="color:#94a3b8;">ä¼ä¸šæ•°æ®åº“</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4 style="color:white; margin-bottom:20px;">æ•°æ®å›¾è°±</h4>
                    <ul style="font-size:0.9rem; color:#94a3b8;">
                        <li style="margin-bottom:10px;"><a href="chart-funding.html" style="color:#94a3b8;">å…¨çƒèèµ„è¶‹åŠ¿</a></li>
                        <li style="margin-bottom:10px;"><a href="chart-cities.html" style="color:#94a3b8;">è¯•ç‚¹åŸå¸‚åˆ†å¸ƒ</a></li>
                        <li style="margin-bottom:10px;"><a href="chart-companies.html" style="color:#94a3b8;">äº§ä¸šé“¾å…¨æ™¯å›¾</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4 style="color:white; margin-bottom:20px;">å…³äº</h4>
                    <ul style="font-size:0.9rem; color:#94a3b8;">
                        <li style="margin-bottom:10px;"><a href="#" style="color:#94a3b8;">å›¢é˜Ÿæ„¿æ™¯</a></li>
                        <li style="margin-bottom:10px;"><a href="#" style="color:#94a3b8;">å¯»æ±‚æŠ¥é“</a></li>
                        <li style="margin-bottom:10px;"><a href="#" style="color:#94a3b8;">å•†åŠ¡åˆä½œ</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright" style="border-top:1px solid #334155; padding-top:20px; margin-top:40px; text-align:center; color:#64748b; font-size:0.85rem;">
                &copy; 2025 LowAltitude Insight. All rights reserved. äº¬ICPå¤‡XXXXXXXXå·
            </div>
        </div>
    </footer>

    <!-- 7. JavaScript é€»è¾‘ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://cpvisbzlzatfdqakqsul.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwdmlzYnpsemF0ZmRxYWtxc3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzOTgwMTYsImV4cCI6MjA3OTk3NDAxNn0.R__eoUjpzFP9_SUxIVnM9T1zpl1pcBTGMzxXLf-Orcg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        function toggleMenu() { 
            document.getElementById('navMenu').classList.toggle('active'); 
        }

        document.addEventListener('DOMContentLoaded', async function() {
            checkUserLogin();
            loadHomeNews();
            // loadHomePolicies();
            // loadHomeCompanies();
            loadHomeReports();
            const cards = document.querySelectorAll('.data-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100 * index);
            });
        });

        // â˜…â˜…â˜… ä¿®æ­£ç‚¹ 2ï¼šä¼˜åŒ–æ–°é—»åŠ è½½å‡½æ•°ï¼Œæ·»åŠ  ID è·³è½¬é“¾æ¥ â˜…â˜…â˜…
        async function loadHomeNews() {
            const { data: newsData } = await _supabase
                .from('news')
                .select('*')
                .eq('draft', false) // â˜…â˜…â˜… å»ºè®®åŠ ä¸Šè¿™ä¸€è¡Œ â˜…â˜…â˜…
                .order('publish_date', { ascending: false })
                .limit(5);

            const newsContainer = document.getElementById('home-news-container');
            if (newsData && newsData.length > 0) {
                newsContainer.innerHTML = '';
                newsData.forEach(item => {
                    const bgStyle = item.image_url 
                        ? `background: #cbd5e1 url('${item.image_url}') center/cover;` 
                        : `background: #cbd5e1;`;

                    // æ ¸å¿ƒä¿®æ”¹ï¼š
                    // 1. æŠŠ href="news.html" æ”¹ä¸º href="news-detail.html?id=${item.id}"
                    // 2. å°† class="news-image" çš„ div æ”¹ä¸º a æ ‡ç­¾ï¼Œè®©å›¾ç‰‡ä¹Ÿèƒ½ç‚¹å‡»
                    newsContainer.innerHTML += `
                        <article class="news-item">
                            <a href="news-detail.html?id=${item.id}" class="news-image" style="${bgStyle}; display:block;"></a>
                            <div class="news-content">
                                <h3><a href="news-detail.html?id=${item.id}">${item.title}</a></h3>
                                <div class="news-meta">
                                    <span class="tag">${item.category}</span>
                                    <span>${item.publish_date}</span>
                                </div>
                                <p style="font-size:0.9rem; color:#64748b; margin-top:8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${item.summary}</p>
                            </div>
                        </article>
                    `;
                });
            } else {
                newsContainer.innerHTML = '<p style="text-align:center; padding:20px;">æš‚æ— æ–°é—»</p>';
            }
        }

        // å…¶ä»–å‡½æ•°ä¿æŒä¸å˜
        async function loadHomePolicies() {
            const container = document.getElementById('home-policy-list');
            
            // â˜…â˜…â˜… å…³é”®ä¿®æ”¹1ï¼šå¿…é¡»æŸ¥è¯¢ 'id' å­—æ®µï¼Œå¦åˆ™æ— æ³•è·³è½¬è¯¦æƒ…é¡µ â˜…â˜…â˜…
            // åŒæ—¶æŸ¥è¯¢ title, region_type (åœ°åŒº), publish_date ç­‰ç”¨äºå±•ç¤º
            const { data } = await _supabase
                .from('policies')
                .select('id, title, region_type, department, publish_date') 
                
                .order('publish_date', { ascending: false })
                .limit(4); // æˆªå›¾é‡Œå¤§æ¦‚åªæœ‰3-4æ¡ï¼Œæ•°é‡å¤ªå¤šä¼šå¾ˆé•¿

            if (data && data.length > 0) {
                container.innerHTML = '';
                data.forEach(item => {
                    // å¤„ç†æ ‡ç­¾æ˜¾ç¤ºï¼šå¦‚æœæœ‰ region_type å°±æ˜¾ç¤ºï¼Œæ²¡æœ‰å°±æ˜¾ç¤º 'æ”¿ç­–'
                    // æˆªå›¾ä¸­çš„æ ·å¼æ˜¯ï¼šä¸­å›½Â·æ·±åœ³ æˆ– æ¬§ç›Ÿ
                    const regionText = item.region_type || 'æ”¿ç­–åŠ¨æ€';

                    // â˜…â˜…â˜… å…³é”®ä¿®æ”¹2ï¼šHTML ç»“æ„å®Œå…¨é‡å†™ï¼ŒåŒ¹é…æˆªå›¾ â˜…â˜…â˜…
                    container.innerHTML += `
                        <li>
                            <!-- æ ‡é¢˜ï¼šç‚¹å‡»è·³è½¬è¯¦æƒ…é¡µ -->
                            <a href="policy-detail.html?id=${item.id}">
                                ${item.title}
                            </a>
                            
                            <!-- æ ‡ç­¾ï¼šç°è‰²å°å— -->
                            <span class="policy-tag">${regionText}</span>
                        </li>
                    `;
                });
            } else {
                container.innerHTML = '<li style="font-size:0.85rem; color:#999; padding:10px 0;">æš‚æ— æ›´æ–°</li>';
            }
        }

        async function loadHomeCompanies() {
            const { data: companyData } = await _supabase
                .from('companies')
                .select('*')
                .eq('draft', false) // â˜…â˜…â˜… å»ºè®®åŠ ä¸Šè¿™ä¸€è¡Œ â˜…â˜…â˜…
                .limit(4);
            
            const companyContainer = document.getElementById('home-company-container');
            if (companyData && companyData.length > 0) {
                companyContainer.innerHTML = '';
                companyData.forEach(item => {
                    let tagsHtml = '';
                    if (item.tags && Array.isArray(item.tags)) {
                        item.tags.slice(0, 2).forEach(tag => {
                            const activeClass = (tag === 'å·²ä¸Šå¸‚' || tag === 'ç‹¬è§’å…½') ? 'highlight' : '';
                            tagsHtml += `<span class="company-tag ${activeClass}">${tag}</span>`;
                        });
                    }
                    companyContainer.innerHTML += `
                        <div class="company-card">
                            <div class="company-header">
                                <div class="company-logo-box">${item.logo_text || item.name.substring(0,2)}</div>
                                <div>
                                    <div style="font-weight:700;">${item.name}</div>
                                    <div style="font-size:0.75rem; color:#94a3b8;">${item.location}</div>
                                </div>
                            </div>
                            <p class="company-desc">${item.description}</p>
                            <div class="company-tags">${tagsHtml}</div>
                        </div>
                    `;
                });
            } else {
                companyContainer.innerHTML = '<p style="text-align:center; padding:20px;">æš‚æ— æ•°æ®</p>';
            }
        }

        async function checkUserLogin() {
            const { data: { session } } = await _supabase.auth.getSession();
            const btn = document.getElementById('auth-btn');
            if (!btn) return;
            if (session) {
                const emailName = session.user.email.split('@')[0];
                btn.innerText = emailName;
                btn.style.backgroundColor = '#475569';
                btn.onclick = function() { window.location.href = 'profile.html'; };
            } else {
                btn.innerText = 'è®¢é˜…/ç™»å½•';
                btn.onclick = function() { window.location.href = 'login.html'; };
            }
        }

        // --- å…¨å±€å˜é‡ç”¨äºåˆ†é¡µ ---
        let allFeedData = []; // å­˜å‚¨èšåˆåçš„æ‰€æœ‰æ•°æ®
        let currentPage = 1;
        const itemsPerPage = 6;

        // é¡µé¢åŠ è½½å…¥å£
        document.addEventListener('DOMContentLoaded', async function() {
            checkUserLogin();
            
            // â˜…â˜…â˜… æ›¿æ¢åŸæ¥çš„ loadHomeNews()ï¼Œæ”¹ä¸ºåŠ è½½èšåˆæ•°æ® â˜…â˜…â˜…
            await loadUnifiedFeed(); 
            
            // ä¿æŒåŸæœ‰çš„å…¶ä»–åŠ è½½å‡½æ•°
            loadHomePolicies(); 
            loadHomeCompanies();
            
            // åŠ¨ç”»æ•ˆæœ
            const cards = document.querySelectorAll('.data-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100 * index);
            });
        });

        // â˜…â˜…â˜… æ–°å¢ï¼šåŠ è½½é¦–é¡µä¾§è¾¹æ çš„æ·±åº¦æŠ¥å‘Š â˜…â˜…â˜…
        async function loadHomeReports() {
            const container = document.getElementById('home-report-list');
        
            // æŸ¥è¯¢ deep_reports è¡¨
            const { data, error } = await _supabase
                .from('deep_reports')
                .select('id, title, author, publish_date, summary') 
                .eq('draft', false) 
                .order('publish_date', { ascending: false })
                .limit(5);

            // â˜…â˜…â˜… ä¿®æ”¹ç‚¹ï¼šå¦‚æœå‡ºé”™ï¼ŒæŠŠé”™è¯¯æ‰“å°åœ¨é¡µé¢ä¸Šï¼Œæ–¹ä¾¿ä½ çœ‹ â˜…â˜…â˜…
            if (error) { 
                console.error("åŠ è½½æŠ¥å‘Šå¤±è´¥:", error); 
                container.innerHTML = `<p style="color:red; font-size:0.85rem; text-align:center;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
                return; 
            }

            if (data && data.length > 0) {
                container.innerHTML = '';
                data.forEach(item => {
                    container.innerHTML += `
                        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #f1f5f9;">
                            <a href="report-detail.html?id=${item.id}" style="font-weight:600; font-size:0.95rem; color:#1e293b; display:block; margin-bottom:4px; line-height:1.4;">
                                ${item.title}
                            </a>
                            <div style="font-size:0.75rem; color:#64748b; display:flex; justify-content:space-between;">
                                <span>ğŸ‘¤ ${item.author || 'LowAltitude æ™ºåº“'}</span>
                                <span>${item.publish_date}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = '<p style="font-size:0.85rem; color:#999; text-align:center;">æš‚æ— æŠ¥å‘Šå‘å¸ƒ</p>';
            }
            }

        // â˜…â˜…â˜… æ ¸å¿ƒå‡½æ•°ï¼šèšåˆ News, Policies, Tech_Trends â˜…â˜…â˜…
        async function loadUnifiedFeed() {
            const container = document.getElementById('unified-feed-container');
            container.innerHTML = '<div class="loading-spinner">æ­£åœ¨èšåˆå¤šæºæ•°æ®...</div>';

            try {
                // 1. å¹¶è¡Œè¯·æ±‚ä¸‰å¼ è¡¨çš„æ•°æ®
                const [newsRes, policiesRes, techRes] = await Promise.all([
                    _supabase.from('news').select('*').eq('draft', false) .order('publish_date', { ascending: false }).limit(20),
                    _supabase.from('policies').select('*').eq('draft', false) .order('publish_date', { ascending: false }).limit(20),
                    _supabase.from('tech_trends').select('*').eq('draft', false) .order('publish_date', { ascending: false }).limit(20)
                ]);

                // 2. æ•°æ®æ ‡å‡†åŒ– (å¢åŠ  type å‚æ•°)
                
                // News -> type=news
                const newsItems = (newsRes.data || []).map(item => ({
                    id: item.id,
                    title: item.title,
                    date: item.publish_date,
                    summary: item.summary,
                    tag: item.category || 'èµ„è®¯',
                    image: item.image_url,
                    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¼ é€’ type=news â˜…â˜…â˜…
                    link: `news-detail.html?type=news&id=${item.id}`, 
                    sourceType: 'news'
                }));

                // Tech -> type=tech_trends
                const techItems = (techRes.data || []).map(item => ({
                    id: item.id,
                    title: item.title,
                    date: item.publish_date,
                    summary: item.summary,
                    tag: item.type || 'æŠ€æœ¯',
                    image: item.image_url,
                    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¼ é€’ type=tech_trends â˜…â˜…â˜…
                    link: `news-detail.html?type=tech_trends&id=${item.id}`,
                    sourceType: 'tech'
                }));

                // Policies -> å¤–éƒ¨é“¾æ¥ (é€šå¸¸æ”¿ç­–æ˜¯PDFæ–‡ä»¶)
                const policyItems = (policiesRes.data || []).map(item => ({
                    id: item.id,
                    title: item.title,
                    date: item.publish_date,
                    summary: item.summary,
                    tag: item.region_type || 'æ”¿ç­–',
                    image: null,
                    // æ”¿ç­–é€šå¸¸è·³è½¬åˆ° file_urlï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸è·³è½¬
                    link: item.file_url || '#', 
                    extraInfo: item.department,
                    sourceType: 'policy' // æ ‡è®°ä¸º policy ç”¨äºç‰¹æ®Šå¤„ç†ç‚¹å‡»è¡Œä¸º
                }));

                // 3. åˆå¹¶ä¸æ’åº (æŒ‰æœ€æ—©æ—¥æœŸåœ¨å‰: a.date - b.date; æŒ‰æœ€æ–°: b.date - a.date)
                allFeedData = [...newsItems, ...policyItems, ...techItems];
                // è¿™é‡ŒæŒ‰ç…§ä½ çš„è¦æ±‚â€œæŒ‰ç…§æœ€æ—©æ—¥æœŸå»æ’åºâ€
                allFeedData.sort((a, b) => new Date(a.date) - new Date(b.date)); 
                
                // å¦‚æœä½ æƒ³æ”¹å›â€œæœ€æ–°åœ¨å‰â€ï¼Œç”¨ä¸‹é¢è¿™è¡Œï¼š
                // allFeedData.sort((a, b) => new Date(b.date) - new Date(a.date));

                // 4. æ¸²æŸ“é¡µé¢
                renderPage(1);
                document.getElementById('pagination-box').style.display = 'flex';

            } catch (err) {
                console.error(err);
                container.innerHTML = '<p style="text-align:center; color:red;">æ•°æ®åŠ è½½å¼‚å¸¸</p>';
            }
        }

        // â˜…â˜…â˜… åˆ†é¡µæ¸²æŸ“å‡½æ•° â˜…â˜…â˜…
        function renderPage(page) {
            const container = document.getElementById('unified-feed-container');
            const totalPages = Math.ceil(allFeedData.length / itemsPerPage);
            
            // è¾¹ç•Œæ£€æŸ¥
            if (page < 1) page = 1;
            if (page > totalPages && totalPages > 0) page = totalPages;
            currentPage = page;

            // è®¡ç®—åˆ‡ç‰‡
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = allFeedData.slice(start, end);

            container.innerHTML = '';

            if (pageData.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px;">æš‚æ— æ•°æ®</p>';
                return;
            }

            pageData.forEach(item => {
                // å¤„ç†å›¾ç‰‡æ˜¾ç¤ºé€»è¾‘
                let imageHtml = '';
                if (item.image) {
                    imageHtml = `<div class="news-image" style="background: #cbd5e1 url('${item.image}') center/cover;"></div>`;
                } else if (item.sourceType === 'policy') {
                    // æ”¿ç­–æ²¡æœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºä¸€ä¸ªå¸¦æ–‡å­—çš„æ–¹å—
                    imageHtml = `<div class="news-image placeholder-policy">${item.tag}</div>`;
                } else {
                    imageHtml = `<div class="news-image" style="background: #cbd5e1;"></div>`; // é»˜è®¤ç°åº•
                }

                // å¤„ç†æ ‡ç­¾é¢œè‰²
                let tagStyle = '';
                if(item.sourceType === 'policy') tagStyle = 'background:#e0f2fe; color:#0284c7;';
                if(item.sourceType === 'tech') tagStyle = 'background:#f0fdf4; color:#15803d;';

                const html = `
                    <article class="news-item">
                        <a href="${item.link}" target="${item.sourceType === 'policy' ? '_blank' : '_self'}" style="display:block; flex-shrink:0;">
                            ${imageHtml}
                        </a>
                        <div class="news-content">
                            <h3><a href="${item.link}" target="${item.sourceType === 'policy' ? '_blank' : '_self'}">${item.title}</a></h3>
                            <div class="news-meta">
                                <span class="tag" style="${tagStyle}">${item.tag}</span>
                                <span>${item.date}</span>
                                ${item.extraInfo ? `<span style="color:#94a3b8; font-size:0.75rem; margin-left:10px;">${item.extraInfo}</span>` : ''}
                            </div>
                            <p style="font-size:0.9rem; color:#64748b; margin-top:8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${item.summary || item.title}
                            </p>
                        </div>
                    </article>
                `;
                container.innerHTML += html;
            });

            // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
            updatePaginationUI(totalPages);
        }

        function updatePaginationUI(totalPages) {
            document.getElementById('page-indicator').innerText = `${currentPage} / ${totalPages || 1}`;
            document.getElementById('btn-prev').disabled = (currentPage === 1);
            document.getElementById('btn-next').disabled = (currentPage === totalPages || totalPages === 0);
        }

        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶è°ƒç”¨æ­¤å‡½æ•°
        function changePage(offset) {
            renderPage(currentPage + offset);
        }
    </script>
</body>


</html>
